<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Search Query Builder Playground</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- External libs -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #f9fafb;
        color: #111;
        margin: 0;
        padding: 2rem;
      }
      h1 {
        text-align: center;
        color: #2563eb;
        margin-bottom: 1.5rem;
      }
      .search-container {
        max-width: 700px;
        margin: 0 auto;
        position: relative;
      }
      input[type="text"] {
        width: 100%;
        padding: 1rem 1.25rem;
        font-size: 1rem;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 3px 8px rgba(37, 99, 235, 0.15);
      }
      .metrics {
        display: flex;
        justify-content: space-around;
        margin: 1rem auto;
        max-width: 700px;
        font-size: 0.9rem;
        color: #4b5563;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin: 1rem auto;
        max-width: 700px;
        overflow: hidden;
      }
      .card-header {
        background: #eff6ff;
        padding: 0.75rem 1rem;
        font-weight: 600;
        cursor: pointer;
        color: #1d4ed8;
        user-select: none;
      }
      .card-content {
        padding: 1rem 1.25rem;
        display: none;
        border-top: 1px solid #e5e7eb;
      }
      .card.open .card-content {
        display: block;
      }
      .pill {
        display: inline-block;
        background: #e0e7ff;
        color: #1e3a8a;
        border-radius: 16px;
        padding: 0.25rem 0.75rem;
        margin: 0.25rem;
        font-size: 0.85rem;
      }
      .score-bar {
        background: #dbeafe;
        border-radius: 6px;
        margin: 4px 0;
        position: relative;
        overflow: hidden;
        height: 20px;
      }
      .score-fill {
        background: linear-gradient(90deg, #3b82f6, #2563eb);
        height: 100%;
        color: #fff;
        font-size: 0.8rem;
        text-align: left;
        padding-left: 6px;
        line-height: 20px;
        transition: width 0.4s ease;
      }
      .history {
        max-width: 700px;
        margin: 1rem auto;
        font-size: 0.9rem;
        color: #374151;
      }
      .history span {
        display: inline-block;
        background: #f3f4f6;
        border-radius: 8px;
        padding: 0.35rem 0.75rem;
        margin: 0.25rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      .history span:hover {
        background: #e5e7eb;
      }
    </style>
  </head>

  <body>
    <h1>üîç Search Query Builder Playground</h1>
    <div class="search-container">
      <input
        id="searchBox"
        type="text"
        placeholder='Type something like: Do I need to disclose "my roth IRA" as a "personal trading account"'
      />
    </div>
    <div class="metrics">
      <div>‚è±Ô∏è Time: <span id="timeMs">0</span> ms</div>
      <div>üß© Tokens: <span id="tokenCount">0</span></div>
      <div>üéØ Matches: <span id="matchCount">0</span></div>
    </div>

    <div id="results"></div>

    <div class="history">
      <strong>Recent Searches:</strong> <span id="history"></span>
    </div>

    <script type="module">
      import { SearchQueryBuilder } from "../dist/search-query-builder-hybrid.js";

      const stopWords = new Set([
        "do",
        "i",
        "need",
        "to",
        "as",
        "a",
        "are",
        "for",
        "how",
      ]);
      const utterances = [
        "personal trading account",
        "trading account",
        "account",
        "ira",
        "pre clearance approval",
        "pre clear",
        "approval",
        "equity holding",
      ];

      const builder = new SearchQueryBuilder({
        stopWords,
        utterances,
        includeContainedMatches: true,
        fuzzyThreshold: 0.3,
      });

      const input = document.getElementById("searchBox");
      const results = document.getElementById("results");
      const timeEl = document.getElementById("timeMs");
      const tokenEl = document.getElementById("tokenCount");
      const matchEl = document.getElementById("matchCount");
      const historyEl = document.getElementById("history");
      const history = [];

      function createCard(title, contentHTML) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<div class="card-header">${title}</div>
                        <div class="card-content">${contentHTML}</div>`;
        card
          .querySelector(".card-header")
          .addEventListener("click", () => card.classList.toggle("open"));
        return card;
      }

      function renderResults(res, timeTaken) {
        results.innerHTML = "";
        tokenEl.textContent = res.cleanedTokens.length;
        matchEl.textContent = res.utteranceMatches.length;
        timeEl.textContent = timeTaken.toFixed(2);

        const tokenHTML = res.cleanedTokens
          .map((t) => `<span class='pill'>${t}</span>`)
          .join("");
        const phraseHTML = res.protectedPhrases
          .map((p) => `<span class='pill'>${p}</span>`)
          .join("");
        // Get Fuse.js fuzzy scores dynamically
        let fuzzyResults = [];
        if (builder.fuse && input.value.trim()) {
          fuzzyResults = builder.fuse.search(input.value.trim());
        }

        const fuzzyHTML = fuzzyResults.length
          ? fuzzyResults
              .map((r) => {
                const confidence = (100 - r.score * 100).toFixed(1);
                const width = Math.max(10, 100 - r.score * 100);
                return `
          <div class="score-bar">
            <div class="score-fill" style="width:${width}%">
              ${r.item} ‚Äî <span style="font-size:0.8rem;">${confidence}%</span>
            </div>
          </div>`;
              })
              .join("")
          : `<em>No fuzzy matches found</em>`;

        const queryHTML = `<code style="white-space: pre-wrap;">${res.queryString}</code>`;

        results.append(
          createCard("Tokens", tokenHTML),
          createCard("Protected Phrases", phraseHTML),
          createCard("Fuzzy Matches", fuzzyHTML),
          createCard("Final Query", queryHTML)
        );
      }

      input.addEventListener(
        "input",
        _.debounce(() => {
          const query = input.value.trim();
          if (!query) return;

          const t0 = performance.now();
          const res = builder.prepare(query);
          const t1 = performance.now();
          renderResults(res, t1 - t0);

          if (!history.includes(query)) {
            history.unshift(query);
            if (history.length > 5) history.pop();
            historyEl.innerHTML = history
              .map((q) => `<span>${q}</span>`)
              .join("");
          }
        }, 300)
      );

      historyEl.addEventListener("click", (e) => {
        if (e.target.tagName === "SPAN") {
          input.value = e.target.textContent;
          input.dispatchEvent(new Event("input"));
        }
      });
    </script>
  </body>
</html>
